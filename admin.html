<!DOCTYPE html>
<html lang="en"><!-- Basic -->
<head>
	<meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">   
   
    <!-- Mobile Metas -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
 
     <!-- Site Metas -->
    <title>Home</title>  
    <meta name="keywords" content="">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Site Icons -->
    <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="css/bootstrap.min.css">    
	<!-- Site CSS -->
    <link rel="stylesheet" href="css/style.css">    
    <!-- Responsive CSS -->
    <link rel="stylesheet" href="css/responsive.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/custom.css">

</head>

<body>



	<!-- Start header -->
	<header class="top-navbar">
		<nav class="navbar navbar-expand-lg navbar-light bg-light">
			<div class="container">
				<a class="navbar-brand" href="index.html">
					<img src="images/logo.png" height="80" alt="" />
				</a>
				<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbars-rs-food" aria-controls="navbars-rs-food" aria-expanded="false" aria-label="Toggle navigation">
				  <span class="navbar-toggler-icon"></span>
				</button>
				<div class="collapse navbar-collapse" id="navbars-rs-food">
					<ul class="navbar-nav ml-auto">
						<li class="nav-item active"><a class="nav-link" href="admin.html">Home</a></li>
						<li class="nav-item"><a class="nav-link" data-toggle="modal" data-target="#logoutModal">Logout</a></li>
					</ul>
				</div>
			</div>
		</nav>
	</header>
	<!-- End header -->


	<div class="about-sections-box" >
		<div class="container" style="padding-top: 200px;">
			<div class="row">
					<h1 class="my-4">User Data</h1>
      <table class="table">
        <thead class="thead-dark">
          <tr>
            <th>ID No.</th>
            <th>First Name</th>
            <th>Last Name</th>
            <th>Username</th>
            <th>Email</th>
            <th>Update</th>
      		  <th>Delete</th>
          </tr>
        </thead>
        <tbody id="user-table"></tbody>
      </table>
			</div>
			
		</div>
      
  </div>

		<!-- Modal for Update -->
		<div id="update-modal" class="modal fade" tabindex="-1" role="dialog">
		  <div class="modal-dialog" role="document">
		    <div class="modal-content">
		      <div class="modal-header">
		        <h5 class="modal-title">Update User</h5>
		        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
		          <span aria-hidden="true">&times;</span>
		        </button>
		      </div>
		      <div class="modal-body">
		        <form id="update-form">
		          <div class="form-group">
		            <label for="update-fname">First Name:</label>
		            <input type="hidden" id="update-id">
		            <input type="text" id="update-fname" class="form-control" name="fname" required>
		          </div>

		          <div class="form-group">
		            <label for="update-lname">Last Name:</label>
		            <input type="text" id="update-lname" class="form-control" name="lname" required>
		          </div>

		          <div class="form-group">
		            <label for="update-username">Username:</label>
		            <input type="text" id="update-username" class="form-control" name="username" required>
		          </div>

		          <div class="form-group">
		            <label for="update-email">Email:</label>
		            <input type="email" id="update-email" class="form-control" name="email" required>
		            <input type="hidden" id="update-password">
		          </div>

		          <button type="submit" id="update-button-modal" class="btn btn-primary">Update</button>
		        </form>
		      </div>
		    </div>
		  </div>
		</div>

		<!-- Modal for Delete -->
		<div id="delete-modal" class="modal fade" tabindex="-1" role="dialog">
		  <div class="modal-dialog" role="document">
		    <div class="modal-content">
		      <div class="modal-header">
		        <h5 class="modal-title">Delete User</h5>
		        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
		          <span aria-hidden="true">&times;</span>
		        </button>
		      </div>
		      <div class="modal-body">
		        <p>Are you sure you want to delete this user?</p>
		        <input type="hidden" id="delete-userid">
		        <input type="hidden" id="delete-fname">
		        <input type="hidden" id="delete-lname">
		        <input type="hidden" id="delete-username">
		        <input type="hidden" id="delete-email">
		        <input type="hidden" id="delete-password">
		        <button id="delete-button-modal" class="btn btn-danger">Delete</button>
		        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
		      </div>
		    </div>
		  </div>
		</div>

		<!-- Logout Modal -->
		<div class="modal" id="logoutModal" tabindex="-1" role="dialog">
		  <div class="modal-dialog" role="document">
		    <div class="modal-content">
		      <div class="modal-header">
		        <h5 class="modal-title">Confirm Logout</h5>
		        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
		          <span aria-hidden="true">&times;</span>
		        </button>
		      </div>
		      <div class="modal-body">
		        <p>Are you sure you want to log out?</p>
		      </div>
		      <div class="modal-footer">
		        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
		        <button type="button" class="btn btn-danger" id="logout-btn">Logout</button>
		      </div>
		    </div>
		  </div>
		</div>
	
	<!-- Start Contact info -->
	<div class="contact-imfo-box">
		<div class="container">
			<div class="row">
				<div class="col-md-4 arrow-right">
					<i class="fa fa-volume-control-phone"></i>
					<div class="overflow-hidden">
						<h4>Phone</h4>
						<p class="lead">
							+63 997 163 4841
						</p>
					</div>
				</div>
				<div class="col-md-4 arrow-right">
					<i class="fa fa-envelope"></i>
					<div class="overflow-hidden">
						<h4>Email</h4>
						<p class="lead">
							genobebe10@gmail.com
						</p>
					</div>
				</div>
				<div class="col-md-4">
					<i class="fa fa-map-marker"></i>
					<div class="overflow-hidden">
						<h4>Location</h4>
						<p class="lead">
							105, Samson Road St, Caloocan
						</p>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!-- End Contact info -->
	
	<!-- Start Footer -->
	<footer class="footer-area bg-f">
		<div class="container">
			<div class="row">
				<div class="col-lg-3 col-md-6">
					<h3>About Us</h3>
					<p>KS Cuisine is a food business that started by selling baked beef lasagna. The owner, a passionate cook, started the business with the goal of sharing her love of food with others. As the business began to grow, the owner saw an opportunity to expand the menu by adding more dishes that she personally enjoyed and believed would be popular among her customers.</p>
				</div>
				<div class="col-lg-3 col-md-6">
					<h3>Subscribe</h3>
					<div class="subscribe_form">
						<form class="subscribe_form">
							<input name="EMAIL" id="subs-email" class="form_input" placeholder="Email Address..." type="email">
							<button type="submit" class="submit">SUBSCRIBE</button>
							<div class="clearfix"></div>
						</form>
					</div>
					<ul class="list-inline f-social">
						<li class="list-inline-item"><a href="https://www.facebook.com/profile.php?id=100068002704860"><i class="fa fa-facebook" aria-hidden="true"></i></a></li>
						<li class="list-inline-item"><a href="#"><i class="fa fa-twitter" aria-hidden="true"></i></a></li>
						<li class="list-inline-item"><a href="#"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li>
						<li class="list-inline-item"><a href="#"><i class="fa fa-google-plus" aria-hidden="true"></i></a></li>
						<li class="list-inline-item"><a href="#"><i class="fa fa-instagram" aria-hidden="true"></i></a></li>
					</ul>
				</div>
				<div class="col-lg-3 col-md-6">
					<h3>Contact information</h3>
					<p class="lead">UE-Caloocan, Samson Road, Caloocan, Philippines</p>
					<p class="lead"><a href="#">+63 997 163 4841</a></p>
					<p><a href="#"> genobebe10@gmail.com</a></p>
				</div>
				<div class="col-lg-3 col-md-6">
					<h3>Opening hours</h3>
					<p><span class="text-color">Monday: </span>Closed</p>
					<p><span class="text-color">Tue-Wed :</span> 9:Am - 10PM</p>
					<p><span class="text-color">Thu-Fri :</span> 9:Am - 10PM</p>
					<p><span class="text-color">Sat-Sun :</span> 5:PM - 10PM</p>
				</div>
			</div>
		</div>
		
		<div class="copyright">
			<div class="container">
				<div class="row">
					<div class="col-lg-12">
						<p class="company-name">All Rights Reserved. &copy; 2020 <a href="#">KS Cuisine</a> Design By : 
					<a href="https://html.design/">JC's group</a></p>
					</div>
				</div>
			</div>
		</div>
		
	</footer>
	<!-- End Footer -->
	
	<a href="#" id="back-to-top" title="Back to top" style="display: none;"><i class="fa fa-paper-plane-o" aria-hidden="true"></i></a>

	<!-- ALL JS FILES -->
	<script src="js/jquery-3.2.1.min.js"></script>
	<script src="js/popper.min.js"></script>
	<script src="js/bootstrap.min.js"></script>
    <!-- ALL PLUGINS -->
	<script src="js/jquery.superslides.min.js"></script>
	<script src="js/images-loded.min.js"></script>
	<script src="js/isotope.min.js"></script>
	<script src="js/baguetteBox.min.js"></script>
	<script src="js/form-validator.min.js"></script>
  <script src="js/contact-form-script.js"></script>
  <script src="js/custom.js"></script>

  <script type="module">
	 // Import the functions you need from the SDKs you need
		import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.21.0/firebase-app.js';
		import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-analytics.js";
		
		// TODO: Add SDKs for Firebase products that you want to use
		// https://firebase.google.com/docs/web/setup#available-libraries

		// Your web app's Firebase configuration
		// For Firebase JS SDK v7.20.0 and later, measurementId is optional
		const firebaseConfig = {
		  apiKey: "AIzaSyB4mZ38aXTLeiQdnlr6qfweQioYKG0j1yU",
		  authDomain: "ks-cuisine.firebaseapp.com",
		  databaseURL: "https://ks-cuisine-default-rtdb.firebaseio.com",
		  projectId: "ks-cuisine",
		  storageBucket: "ks-cuisine.appspot.com",
		  messagingSenderId: "446458909737",
		  appId: "1:446458909737:web:8976d968b60ae0b3f0f838",
		  measurementId: "G-4DW5VGPK6B"
		};

		import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail, updateEmail, deleteUser } from 'https://www.gstatic.com/firebasejs/9.21.0/firebase-auth.js'
		import { getDatabase, ref, set, limitToLast, get, orderByKey, query, equalTo, onValue, orderByChild, remove, update } from 'https://www.gstatic.com/firebasejs/9.21.0/firebase-database.js';

		// Initialize Firebase
		const app = initializeApp(firebaseConfig);
		const analytics = getAnalytics(app);
		const auth = getAuth();
		const database = getDatabase();
		const userRef = ref(database, 'Users');
		const userTable = document.getElementById('user-table');
		const updateButtonModal = document.getElementById('update-button-modal');
		const deleteButtonModal = document.getElementById('delete-button-modal')
		const logoutBtn = document.getElementById('logout-btn');

		// Array to store selected user details
	  let selectedUser = [];


		const queryRef = query(userRef, orderByKey(), limitToLast(1));
		get(queryRef)
			.then((snapshot) => {
				if(snapshot.exists()) {
					const lastChildKey = Object.keys(snapshot.val())[0];
					sessionStorage.setItem('lastId', lastChildKey);
				}
				else {
					console.log("No data available")
				}				
			})
			.catch((error) => {
				console.log("Error fetching data", error);
			});

			updateButtonModal.addEventListener('click', async () => {
				event.preventDefault(); 
				try {
					const userId = document.getElementById('update-id');
					const fName = document.getElementById('update-fname');
					const lName = document.getElementById('update-lname');
					const username = document.getElementById('update-username');
					const emailModal = document.getElementById('update-email');
					const passwordModal = document.getElementById('update-password');
					const email = emailModal.value;
					const password = passwordModal.value;

					// Update the user's email in Firebase Authentication
					console.log(email);
					console.log(password);

					const user = auth.currentUser;
					console.log(user);

					await updateEmail(user, email);
					console.log('Email address updated successfully');

					await signOut(auth);
					console.log("User logged out");

					// get the updated user values and store it
					const updatedUserDetails = {
						firstName: fName.value,
						lastName: lName.value,
						username: username.value,
						email: emailModal.value
					};
					// Update the user data in the database
          update(ref(database, `Users/${userId.value}`), updatedUserDetails)
            .then(() => {
              alert('User updated successfully!');
              $('#update-modal').modal('hide');
            })
            .catch((error) => {
              console.log('Error updating user:', error);
            });
	      
					// const userQuery = 
				}catch(error) {
					console.log("Error: ", error);
				}
			});

			// Logout any authenticated user from admin
			logoutBtn.addEventListener('click', async () => {
			  await signOut(auth);
				window.location.href = 'index.html';
				alert("Admin has been logout.");

			});

			deleteButtonModal.addEventListener('click', async () => {
			  try {
			    const userId = document.getElementById('delete-userid');
			    const user = auth.currentUser;
			    
			    // Delete user from Firebase Authentication
			    await deleteUser(user, userId);
			    console.log('User deleted from Firebase Authentication successfully');
			    
			    // Delete user from Realtime Database
			    remove(ref(database, `Users/${userId.value}`))
			    	.then(() => {
			    		console.log('User deleted from Realtime Database successfully');			    
			    		alert('User deleted successfully!');
			    		$('#delete-modal').modal('hide');
			    	}).catch((error) => {
			    			console.error('Error deleting user:', error);
			    	})

			    // Perform any additional actions or UI updates after deletion
			  } catch (error) {
			    console.error('Error deleting user:', error);
			    // Handle the error accordingly
			  }
			});

		function populateUserTable(snapshot) {
		  // Clear the user table
		  userTable.innerHTML = '';

		  // Iterate through the users
		  snapshot.forEach((userSnapshot) => {
		    const user = userSnapshot.val();
		    const row = document.createElement('tr');
		    row.innerHTML = `
		      <td>${user.userId}</td>
		      <td>${user.firstName}</td>
		      <td>${user.lastName}</td>
		      <td>${user.username}</td>
		      <td>${user.email}</td>
		      <td><button class="btn btn-primary update-btn" data-toggle="modal" data-target="#update-modal" data-user-id="${user.userId}"><i class="fa fa-pencil"></i></button></td>
		      <td><button class="btn btn-danger delete-btn" data-toggle="modal" data-target="#delete-modal" data-user-id="${user.userId}"><i class="fa fa-trash"></i></button></td>
		    `;
		    userTable.appendChild(row);

		    // Add click event listener to the update button in each row
		    const updateButton = row.querySelector('.update-btn');
		    updateButton.addEventListener('click', () => {
		    	const userId = user.userId;
				  const firstName = user.firstName;
				  const lastName = user.lastName;
				  const username = user.username;
				  const email = user.email;
				  const password = user.password;

				  // Insert each fields in an array
		      selectedUser = [userId, firstName, lastName, username, email, password];
		      document.getElementById('update-id').value = selectedUser[0];
		      document.getElementById('update-fname').value = selectedUser[1];
		      document.getElementById('update-lname').value = selectedUser[2];
		      document.getElementById('update-username').value = selectedUser[3];
		      document.getElementById('update-email').value = selectedUser[4];
		      document.getElementById('update-password').value = selectedUser[5];

		      console.log(selectedUser); // Generate the selected user details to the console

					signInWithEmailAndPassword(auth, email, password)
					.then((userCredential) => {
						const user = userCredential.user;
						console.log('User logged in', user);
					}).catch((error) => {
						  // Error occurred during sign-in
    					const errorCode = error.code;
    					const errorMessage = error.message;
    					console.error('Sign-in error:', errorCode, errorMessage);
					});
		    });

		    // Add click event listener to the delete button in each row
		    const deleteButton = row.querySelector('.delete-btn');
		    deleteButton.addEventListener('click', () => {
		      const userId = user.userId;
		      const firstName = user.firstName;
				  const lastName = user.lastName;
				  const username = user.username;
				  const email = user.email;
				  const password = user.password;
		      
		      // Insert each fields in an array
		      selectedUser = [userId, firstName, lastName, username, email, password];
		      document.getElementById('delete-userid').value = selectedUser[0];
		      document.getElementById('delete-fname').value = selectedUser[1];
		      document.getElementById('delete-lname').value = selectedUser[2];
		      document.getElementById('delete-username').value = selectedUser[3];
		      document.getElementById('delete-email').value = selectedUser[4];
		      document.getElementById('delete-password').value = selectedUser[5];

		      console.log(selectedUser); // Generate the selected user details to the console

		      signInWithEmailAndPassword(auth, email, password)
					.then((userCredential) => {
						const user = userCredential.user;
						console.log('User logged in', user);
					}).catch((error) => {
						  // Error occurred during sign-in
    					const errorCode = error.code;
    					const errorMessage = error.message;
    					console.error('Sign-in error:', errorCode, errorMessage);
					});
		    });
			});
		}

		onValue(userRef, (snapshot) => {
		  populateUserTable(snapshot);
		});

</script>
  
</body>
</html>